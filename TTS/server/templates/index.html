<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="🐸Coqui AI TTS demo server.">
    <meta name="author" content="🐸Coqui AI TTS">
    <title>TTS engine</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
          integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous"
          rel="stylesheet">
    <style>
        .container {
            height: 100vh; /* Set container height to 100% of viewport height */
            display: flex; /* Use flexbox layout */
            overflow: hidden; /* Hide any overflowing content */
        }
        .left-column {
            margin-top: 80px;
            margin-bottom: 80px;
            flex: 1; /* Occupy remaining horizontal space */
            overflow-y: auto; /* Enable vertical scrollbar if content overflows */
        }
        .right-column {
            flex: 1; /* Occupy remaining horizontal space */
        }
      .card {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        width: 300px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 10px;
      }

      .select-button {
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }
    </style>
</head>
<body>
<div class="container">
    <div class="left-column">

        <!-- Left Column - Empty Container -->
        <div id="voice-details-container"></div>
    </div>
    <div class="right-column">
        <div class="text-center">
            <img class="mt-5" src="{{url_for('static', filename='logo.png')}}" align="middle" width="512"/>
            <ul class="list-unstyled"></ul>
            {%if use_gst%}
            <input value='{"0": 0.1}' id="style_wav" placeholder="style wav (dict or path to wav).." size=45 type="text"
                   name="style_wav">
            {%endif%}
            <input id="text" placeholder="Type here..." size=45 type="text" name="text">
            <button id="speak-button" name="speak" class="btn btn-primary">Speak</button>
            <br/><br/>
            {%if use_multi_speaker%}
            Choose a speaker:
                <select id="speaker_id" name=speaker_id method="GET" action="/">
                  {% for speaker_id in speaker_ids %}
                    {% if speaker_id.startswith("VCTK_") %}
                      <option value="{{speaker_id}}" SELECTED>{{speaker_id}}</option>
                    {% endif %}
                  {% endfor %}
                </select><br/><br/>
            {%endif%}
            <!-- Temporary debug statement -->
<!--            {%if use_multi_language%}-->
<!--            Choose a language:-->
<!--            <select id="language_id" name=language_id method="GET" action="/">-->
<!--                {% for language_id in language_ids %}-->
<!--                <option value="{{language_id}}" SELECTED>{{language_id}}</option>-->
<!--                "-->
<!--                {% endfor %}-->
<!--            </select><br/><br/>-->
<!--            {%endif%}-->
            <input type="hidden" id="language_id" name="language_id" value="en">

            <audio id="audio" controls autoplay hidden></audio>
            <p id="message"></p>
            <p id="current-model">Currently evaluating:</p>
            <select id="model-dropdown"></select>
        </div>
    </div>
</div>
<script>
    function getTextValue(textId) {
        const container = q(textId)
        if (container) {
            return container.value
        }
        return ""
    }
    function q(selector) { return document.querySelector(selector) }
    q('#text').focus()
    function do_tts(e) {
        const text = q('#text').value
        const speaker_id = getTextValue('#speaker_id')
        const style_wav = getTextValue('#style_wav')
        const language_id = getTextValue('#language_id')
        if (text) {
            q('#message').textContent = 'Synthesizing...'
            q('#speak-button').disabled = true
            q('#audio').hidden = true
            synthesize(text, speaker_id, style_wav, language_id)
        }
        e.preventDefault()
        return false
    }
    q('#speak-button').addEventListener('click', do_tts)
    q('#text').addEventListener('keyup', function (e) {
        if (e.keyCode == 13) { // enter
            do_tts(e)
        }
    })
    function synthesize(text, speaker_id = "", style_wav = "", language_id = "") {
        fetch(`/api/tts?text=${encodeURIComponent(text)}&speaker_id=${encodeURIComponent(speaker_id)}&style_wav=${encodeURIComponent(style_wav)}&language_id=${encodeURIComponent(language_id)}`, { cache: 'no-cache' })
            .then(function (res) {
                if (!res.ok) throw Error(res.statusText)
                return res.blob()
            }).then(function (blob) {
                q('#message').textContent = ''
                q('#speak-button').disabled = false
                q('#audio').src = URL.createObjectURL(blob)
                q('#audio').hidden = false
            }).catch(function (err) {
                q('#message').textContent = 'Error: ' + err.message
                q('#speak-button').disabled = false
            })
    }
      // Function to make an AJAX request and update the voice details container
// Function to make an AJAX request and update the voice details container
function getModels(callback) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://huggingface.co/api/models?author=voices", true);
  xhr.onload = function () {
    if (xhr.status === 200) {
      var models = JSON.parse(xhr.responseText);
      callback(models);
    }
  };
  xhr.send();
}

function updateVoiceDetails() {
  // Create a new XMLHttpRequest object
  var xhr = new XMLHttpRequest();

  // Configure the request
  xhr.open("GET", "/get_voices", true);

  // Define the callback function to handle the response
  xhr.onload = function () {
    if (xhr.status === 200) {
      // Parse the response as JSON
      var response = JSON.parse(xhr.responseText);

      // Build the HTML string for the voice details
            var voiceDetailsHTML = "";
            for (var i = 0; i < response.length; i++) {
              var speaker = response[i];
              var speakerHTML =
                '<div class="card">' +
                '<div class="label-info">' +
                '<p>' +
                speaker.speaker_id +
                ": " +
                speaker.age +
                " year old " +
                speaker.gender +
                ", " +
                speaker.accents +
                " accent (" +
                speaker.region +
                ")</p>" +
                "</div>" +
                '<div class="player">' +
                '<audio controls>' +
                '<source src="https://huggingface.co/voices/' +
                speaker.project +
                '/resolve/main/samples/' +
                speaker.speaker_id +
                '.wav" type="audio/wav">' +
                "</audio>" +
                "</div>" +
                '<div class="select-button">' +
                '<select id="speaker_id" name="speaker_id" method="GET" action="/">' +
                '<option value="">' +
                speaker.speaker_id +
                "</option>" +
                "</select>" +
                "</div>" +
                "</div>";
              voiceDetailsHTML += speakerHTML;
            }

      // Update the voice details container with the HTML
      document.getElementById("voice-details-container").innerHTML =
        voiceDetailsHTML;

      // Call the getModels function to fetch the models information
      getModels(function (models) {
        var dropdownHTML = "<option value=''>Jump to another model...</option>"
        var currentModelPage = getCurrentModelPage();
        for (var j = 0; j < models.length; j++) {
          var model = models[j];
          var modelName = model.id.split("/").pop();
          if (modelName.startsWith("VCTK_")) {
            if (modelName !== currentModelPage) {
              dropdownHTML +=
                '<option value="' +
                model.id +
                '">' +
                modelName +
                "</option>";
            }
          }
        }

        // Update the model dropdown with the HTML
        document.getElementById("model-dropdown").innerHTML = dropdownHTML;

        // Update the current model paragraph
        document.getElementById("current-model").textContent =
          "Currently evaluating: " + currentModelPage;
      });
    }
  };

  // Send the request
  xhr.send();
}

// Function to handle the model selection change
function onModelSelectChange() {
  var selectedModel = document.getElementById("model-dropdown").value;
  var modelName = selectedModel.split("/").pop();
  var modelUrl = "https://voices-" + modelName.toLowerCase().replace(/_/g, "-") + ".hf.space/";
  // Redirect to the selected model page
  window.location.href = modelUrl;
}

function getCurrentModelPage() {
  var currentUrl = window.location.href;
  var modelPageRegex = /https:\/\/voices-(.*).hf.space/;
  var match = currentUrl.match(modelPageRegex);
  if (match && match.length > 1) {
    var modelName = match[1];
    return "voices/" + modelName.replace(/-/g, "_");
  }
  return "";
}

// Call the updateVoiceDetails function when the page finishes loading
window.addEventListener("load", updateVoiceDetails);

// Add event listener to the model dropdown
document
  .getElementById("model-dropdown")
  .addEventListener("change", onModelSelectChange);

</script>
</body>
</html>
